<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StickyFlow - Retrospective Board</title>

    <!-- Tailwind CSS v4 -->
    <!-- We're using the Tailwind v4 script for styling. It provides utility classes to build the design directly in the HTML. -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SortableJS Library -->
    <!-- This library is used to make the cards draggable and sortable between the columns. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Custom Styles -->
    <!-- A few custom styles are added for a better look and feel, like the ghost class for dragging placeholders. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the placeholder element when a card is being dragged */
        .ghost-card {
            opacity: 0.5;
            border: 2px dashed;
        }
        /* Style to indicate a paragraph is being edited */
        p[contenteditable="true"] {
            outline: none; /* Remove default browser outline */
            box-shadow: 0 0 0 2px #3498db; /* Use box-shadow for a visible outline */
            border-radius: 4px; /* Add a slight radius to the highlight */
        }

        /* Custom Scrollbar Styles */
        .scroll-container {
            scrollbar-gutter: stable; /* Prevents layout shift when scrollbar appears */
        }
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: transparent; /* Makes the track invisible */
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: transparent; /* Scrollbar is invisible by default */
            border-radius: 20px;
            transition: background-color 0.3s ease-in-out;
        }

        /* Style for when the scrollbar should be visible */
        .scrolling::-webkit-scrollbar-thumb {
            background-color: #F8F8F8; /* Lighter, glassy scrollbar thumb */
            border: 1px solid #eee; /* Add a subtle border to make it visible */
        }

        .scrolling::-webkit-scrollbar-thumb:hover {
            background-color: #e0e0e0; /* Slightly darker on hover */
        }


        /* Styles for the fixed feedback button */
        .feedback-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem; /* This correctly positions the button on the right */
            z-index: 50;
            overflow: hidden;
        }

        /* Shine/Glow animation */
        .feedback-button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, rgba(167, 139, 250, 0) 0%, rgba(167, 139, 250, 0.5) 50%, rgba(167, 139, 250, 0) 100%);
            transform: rotate(45deg);
            display: none; /* Hidden by default */
        }

        .shine-effect::after {
            display: block;
            animation: shine 4s forwards;
        }

        @keyframes shine {
            0% {
                transform: rotate(45deg) translateX(-200%) translateY(-200%);
            }
            100% {
                transform: rotate(45deg) translateX(200%) translateY(200%);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white text-gray-800">

<!-- Main container for the entire application -->
<div class="flex flex-col h-screen p-4 md:p-6 lg:p-8">

    <!-- Header Section -->
    <header class="flex items-center justify-between pb-4 border-b shrink-0">
        <!-- Logo -->
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-yellow-300 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            <span class="text-xl font-bold">StickyFlow</span>
        </div>

        <!-- User Avatars -->
        <div class="relative">
            <div id="avatar-list" class="flex items-center space-x-2">
                <!-- Avatars will be dynamically inserted here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-4">
            <button class="flex items-center gap-2 px-4 py-2 text-sm font-semibold border border-gray-300 rounded-lg hover:bg-gray-100">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span>I'm Finished</span>
            </button>
            <button class="px-4 py-2 text-sm font-semibold text-white bg-black rounded-lg hover:bg-gray-800">Present</button>
        </div>
    </header>

    <!-- Main content with three columns -->
    <main id="main-board" class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 overflow-hidden">

        <!-- Column 1: What went well -->
        <div class="flex flex-col">
            <h2 class="text-lg font-semibold text-center pb-2 border-b-2 border-gray-600 mb-4 shrink-0">What went well</h2>
            <div id="col-went-well" class="flex-1 space-y-8 p-2 pt-6 overflow-y-auto scroll-container rounded-lg">
                <!-- Cards will be added here -->
            </div>
        </div>

        <!-- Column 2: What can be improved -->
        <div class="flex flex-col border-l border-r border-gray-200 px-6">
            <h2 class="text-lg font-semibold text-center pb-2 border-b-2 border-gray-600 mb-4 shrink-0">What can be improved</h2>
            <div id="col-can-be-improved" class="flex-1 space-y-8 p-2 pt-6 overflow-y-auto scroll-container rounded-lg">
                <!-- Cards will be added here -->
            </div>
        </div>

        <!-- Column 3: Action Items -->
        <div class="flex flex-col">
            <h2 class="text-lg font-semibold text-center pb-2 border-b-2 border-gray-600 mb-4 shrink-0">Action Items</h2>
            <div id="col-action-items" class="flex-1 space-y-8 p-2 pt-6 overflow-y-auto scroll-container rounded-lg">
                <!-- Cards will be added here -->
            </div>
        </div>
    </main>

    <footer class="text-center pt-4 shrink-0">
        <div class="inline-block border-2 border-dashed border-gray-300 rounded-lg px-6 py-3">
            <p class="text-gray-500 text-sm">double click inside a section to add card</p>
        </div>
    </footer>

</div>

<!-- All Users Modal -->
<div id="all-users-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <!-- Backdrop with blur -->
    <div id="modal-backdrop" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>

    <!-- Modal Panel -->
    <div class="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
        <!-- Modal Header -->
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">All Participants</h3>
            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <!-- Modal Body -->
        <div id="modal-avatar-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 max-h-[60vh] overflow-y-auto p-2 scroll-container">
            <!-- Full user list will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- Fixed Feedback Button -->
<button id="feedback-btn" class="feedback-button px-4 py-2 text-sm font-semibold border border-gray-300 rounded-lg bg-white hover:bg-gray-100">Feedback</button>


<script>
    // --- User Data ---
    const users = Array.from({ length: 20 }, (_, i) => ({
        id: `user${i + 1}`,
        name: `User ${i + 1}`,
        isCurrentUser: i === 3, // Let's say the 4th user is the current one
        status: i % 3 === 0 ? 'active' : 'finished', // Distribute statuses
    }));

    // --- Avatar List and Modal Logic ---
    const avatarListContainer = document.getElementById('avatar-list');
    const allUsersModal = document.getElementById('all-users-modal');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalAvatarGrid = document.getElementById('modal-avatar-grid');

    function renderAvatars() {
        avatarListContainer.innerHTML = ''; // Clear existing
        modalAvatarGrid.innerHTML = ''; // Clear existing

        // Render first 4 avatars or less
        const visibleAvatars = users.slice(0, 4);
        visibleAvatars.forEach(user => {
            avatarListContainer.appendChild(createAvatarElement(user));
        });

        // Add "+N" indicator if there are more than 4 users
        if (users.length > 4) {
            const moreIndicator = document.createElement('div');
            moreIndicator.className = 'flex items-center justify-center h-12 w-12 rounded-full bg-gray-200 text-gray-600 font-semibold cursor-pointer ring-2 ring-white';
            moreIndicator.textContent = `+${users.length - 4}`;
            moreIndicator.id = 'avatar-more-btn';
            avatarListContainer.appendChild(moreIndicator);

            // Event listener to open the modal
            moreIndicator.addEventListener('click', () => allUsersModal.classList.remove('hidden'));
        }

        // Populate the full modal list
        users.forEach(user => {
            modalAvatarGrid.appendChild(createModalAvatarItem(user));
        });
    }

    function createAvatarElement(user) {
        const container = document.createElement('div');
        container.className = 'relative inline-block h-12 w-12';

        let statusIndicator = '';
        if(user.isCurrentUser){
            statusIndicator = `<span class="absolute -bottom-2 left-1/2 -translate-x-1/2 h-1 w-6 bg-purple-500 rounded-full"></span>`;
        } else if (user.status === 'finished') {
            statusIndicator = `
                    <div class="absolute top-0 right-0 h-4 w-4 rounded-full bg-green-500 flex items-center justify-center ring-2 ring-white">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>`;
        } else { // active
            statusIndicator = `
                    <div class="absolute top-0 right-0 h-4 w-4 rounded-full bg-white flex items-center justify-center ring-1 ring-white">
                        <div class="animate-spin rounded-full h-3 w-3 border-2 border-blue-500 border-t-transparent"></div>
                    </div>`;
        }

        container.innerHTML = `
                <img class="h-full w-full" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${user.id}&scale=120" alt="${user.name}">
                ${statusIndicator}
            `;
        return container;
    }

    function createModalAvatarItem(user) {
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center text-center';
        div.innerHTML = `
                <div class="relative w-16 h-16 mb-2">
                    ${createAvatarElement(user).innerHTML}
                </div>
                <span class="text-xs text-gray-600">${user.name}</span>
             `;
        return div;
    }

    // Event listeners to close the modal
    closeModalBtn.addEventListener('click', () => allUsersModal.classList.add('hidden'));
    modalBackdrop.addEventListener('click', () => allUsersModal.classList.add('hidden'));


    // --- Color Configuration for Columns ---
    const colorConfig = {
        'col-went-well': {
            cardBg: 'bg-green-100',
            headerBg: 'bg-green-200',
            text: 'text-green-800',
            ghostBg: '#d4edda',
            ghostBorder: '#28a745',
        },
        'col-can-be-improved': {
            cardBg: 'bg-pink-100',
            headerBg: 'bg-pink-200',
            text: 'text-pink-800',
            ghostBg: '#f8d7da',
            ghostBorder: '#dc3545',
        },
        'col-action-items': {
            cardBg: 'bg-yellow-100',
            headerBg: 'bg-yellow-200',
            text: 'text-yellow-800',
            ghostBg: '#fff3cd',
            ghostBorder: '#ffc107',
        }
    };

    const allColorClasses = {
        cardBg: ['bg-green-100', 'bg-pink-100', 'bg-yellow-100'],
        headerBg: ['bg-green-200', 'bg-pink-200', 'bg-yellow-200'],
        text: ['text-green-800', 'text-pink-800', 'text-yellow-800'],
    };

    // --- Function to Update Card Colors ---
    function updateCardColor(card, columnId) {
        const colors = colorConfig[columnId];
        if (!colors) return;

        const header = card.querySelector('.card-header');
        const voteSpan = card.querySelector('.card-vote');
        const controls = card.querySelector('.card-controls');

        // Remove old colors from all relevant elements
        card.classList.remove(...allColorClasses.cardBg);
        if (header) {
            header.classList.remove(...allColorClasses.headerBg);
        }
        if (voteSpan) {
            voteSpan.classList.remove(...allColorClasses.text);
        }
        if (controls) {
            controls.classList.remove(...allColorClasses.text);
        }


        // Add new colors to all relevant elements
        card.classList.add(colors.cardBg);
        if (header) {
            header.classList.add(colors.headerBg);
        }
        if (voteSpan) {
            voteSpan.classList.add(colors.text);
        }
        if (controls) {
            controls.classList.add(colors.text);
        }
    }

    // --- Function to add a new card ---
    function addCard(columnId, text, isAvatarCard = false, avatarSeed = '') {
        const column = document.getElementById(columnId);
        const colors = colorConfig[columnId];

        const cardEl = document.createElement('div');
        cardEl.className = `card ${colors.cardBg} rounded-lg shadow-sm cursor-grab relative`;

        if(isAvatarCard) {
            cardEl.innerHTML = `
                    <div class="card-header ${colors.headerBg} px-3 py-1 flex justify-between items-center rounded-t-lg">
                        <span class="card-vote text-sm font-semibold ${colors.text}">+${Math.floor(Math.random() * 6)}</span>
                    </div>
                    <img class="absolute top-0 right-3 transform -translate-y-1/2 h-10 w-10" src="https://api.dicebear.com/8.x/adventurer/svg?seed=${avatarSeed}&scale=120" alt="User Avatar">
                    <div class="p-3">
                        <p class="text-xs text-gray-700 break-words">${text}</p>
                    </div>`;
        } else {
            cardEl.innerHTML = `
                    <div class="card-header ${colors.headerBg} px-3 py-1 flex justify-between items-center rounded-t-lg">
                        <span class="card-vote text-sm font-semibold ${colors.text}">+0</span>
                        <div class="card-controls flex gap-3 items-center ${colors.text}">
                            <svg class="w-4 h-4 hover:text-black cursor-pointer delete-btn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="text-xs text-gray-700 break-words">${text}</p>
                    </div>`;
        }

        column.appendChild(cardEl);

        const p = cardEl.querySelector('p');
        if(text === 'New Idea...') {
            p.contentEditable = true;
            p.focus();

            const range = document.createRange();
            range.selectNodeContents(p);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            p.addEventListener('blur', () => {
                p.contentEditable = false;
                if(p.textContent.trim() === '' || p.textContent.trim() === 'New Idea...') {
                    cardEl.remove();
                }
            }, { once: true });
        }
    }

    // --- Populate initial cards ---
    function populateInitialCards() {
        addCard('col-went-well', 'The team collaboration on the new feature was outstanding!', true, 'userA');
        addCard('col-went-well', 'when an unknown printer took a galley of type and scrambled it to make a type specimen book.');
        addCard('col-can-be-improved', 'Some of the API documentation is getting out of date.', true, 'userB');
        addCard('col-can-be-improved', 'when an unknown printer took a galley of type and scrambled it to make a type specimen book.');
        addCard('col-action-items', 'Plan a session to update all the API docs next sprint.', true, 'userC');
        addCard('col-action-items', 'when an unknown printer took a galley of type and scrambled it to make a type specimen book.');
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateInitialCards();
        renderAvatars();
    });


    // --- SortableJS Initialization ---
    const sortableOptions = {
        group: 'shared', // This allows dragging cards between columns with the same group name.
        animation: 150, // Animation speed in ms when sorting.
        ghostClass: 'ghost-card', // The class applied to the placeholder element.
        onEnd: function (evt) {
            // When a card is moved to a new column, update its color.
            const card = evt.item;
            const newColumnId = evt.to.id;
            updateCardColor(card, newColumnId);
        },
        onMove: function (evt) {
            // Dynamically update the ghost card's color based on the target column
            const ghostEl = document.querySelector('.ghost-card');
            if (ghostEl) {
                const targetColId = evt.to.id;
                const colors = colorConfig[targetColId];
                if (colors) {
                    ghostEl.style.backgroundColor = colors.ghostBg;
                    ghostEl.style.borderColor = colors.ghostBorder;
                }
            }
            return true; // The move is allowed
        },
    };

    // Initialize SortableJS on each column.
    document.querySelectorAll('.scroll-container').forEach(col => {
        new Sortable(col, sortableOptions);
    });

    // --- Event Listeners ---
    const mainBoard = document.getElementById('main-board');

    // Listener for single-click to delete a card
    mainBoard.addEventListener('click', function(e) {
        const card = e.target.closest('.card');
        if (!card) return;

        if (e.target.closest('.delete-btn')) {
            card.remove();
        }
    });

    // Listener for double-clicking to add or edit a card
    mainBoard.addEventListener('dblclick', function(e){
        const card = e.target.closest('.card');
        const columnBody = e.target.closest('.scroll-container');

        // If a card was double-clicked, make it editable.
        if(card) {
            const paragraph = card.querySelector('p');
            if (paragraph) {
                paragraph.contentEditable = true;
                paragraph.focus();
                // Optional: Select all text for easy replacement
                const sel = window.getSelection();
                sel.selectAllChildren(paragraph);

                paragraph.addEventListener('blur', () => {
                    paragraph.contentEditable = false;
                }, { once: true });
            }
            return; // Stop further processing to prevent adding a new card
        }

        // If the column body was double-clicked (but not a card), add a new card.
        if(columnBody) {
            addCard(columnBody.id, 'New Idea...');
        }
    });

    // --- Paste as Plain Text ---
    mainBoard.addEventListener('paste', function(e) {
        if (e.target.isContentEditable && e.target.tagName === 'P') {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        }
    });

    // --- Feedback Button Shine Effect ---
    const feedbackBtn = document.getElementById('feedback-btn');
    setInterval(() => {
        feedbackBtn.classList.add('shine-effect');
        setTimeout(() => {
            feedbackBtn.classList.remove('shine-effect');
        }, 4000); // Duration of the shine animation (increased to 4s)
    }, 20000); // Trigger every 20 seconds

    // --- Auto-hiding scrollbar logic ---
    let scrollTimeouts = {};
    document.querySelectorAll('.scroll-container').forEach(column => {
        column.addEventListener('scroll', function(e) {
            if (scrollTimeouts[e.target.id]) {
                clearTimeout(scrollTimeouts[e.target.id]);
            }
            e.target.classList.add('scrolling');
            scrollTimeouts[e.target.id] = setTimeout(() => {
                e.target.classList.remove('scrolling');
            }, 3000);
        });
    });

</script>

</body>
</html>
